<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>æ¸¯å¼å°ç£éº»é›€åˆ†æå™¨ Â· ç¶²é ç‰ˆ</title>
  <style>
    :root{
      --tile-size: clamp(22px, 6vw, 28px);
      --gap-small: 4px;
      --card-pad: 14px;
      --hand-gap: 4px;
      --hand-pad: 8px;
    }

    html, body { height:100%; }
    html { -ms-touch-action: manipulation; touch-action: manipulation; }
    body {
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:#fff;
      background: radial-gradient(1200px 800px at 10% 10%, #0f1a33 10%, #0b1220 60%);
      -webkit-text-size-adjust: 100%;
    }
    .wrap { min-height:100dvh; display:flex; flex-direction:column; }
    .container { width:100%; max-width:980px; margin:0 auto; padding:12px clamp(10px,4vw,20px) 96px; box-sizing:border-box; }

    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
    .title { font-size:clamp(18px,4.8vw,26px); font-weight:800; letter-spacing:.3px; }

    .card {
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:var(--card-pad);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      overflow:visible;
    }

    .section-title{ font-size:12px; color:#fff; text-transform:uppercase; letter-spacing:.16em; margin:6px 0 8px; }
    .muted{ color:#fff; opacity:.9; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* ====== é ‚éƒ¨è¼¸å…¥æ§åˆ¶åˆ— ====== */
    .field { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .field .spacer{ flex:1 1 auto; }

    /* è¼¸å…¥æ¬„ï¼šå±•é–‹æ™‚æ‰é¡¯ç¤ºï¼›å¯¬åº¦ç”± JS å°é½Šåˆ°æ‰‹ç‰Œå…§é‚Šç·£ */
    .input-panel{ display:none; margin-top:8px; width:100%; }
    .input-panel.active{ display:block; }
    .input-align{ width:100%; }     /* JS æœƒæ”¹å®ƒçš„ margin-left èˆ‡ max-width */
    input[type=text]{
      width:100%;
      min-height:44px;
      background:#0b1020; color:#fff;
      border:1px solid rgba(255,255,255,.25);
      padding:10px 12px; border-radius:12px; font-size:16px; outline:none;
      -ms-touch-action: manipulation; touch-action: manipulation;
      box-sizing:border-box;
    }
    input[type=text]::placeholder { color:#ffffffcc; }
    input[type=text]:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.28); }

    .btn {
      background:#0d2347; border:1px solid rgba(255,255,255,.25);
      color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:700; transition:.15s; font-size:15px; min-height:40px;
      -ms-touch-action: manipulation; touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn:hover { border-color:#60a5fa; }
    .btn.primary{ background:linear-gradient(135deg, #2563eb, #22c55e); border:none; color:white; }
    .btn.secondary{ background: linear-gradient(135deg, #4b74c7, #334155); border:none; color:#fff; }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.3); }
    .btn.sm{ font-size:14px; padding:8px 10px; min-height:36px; }

    .dock {
      position:fixed; left:0; right:0; bottom:0; backdrop-filter:blur(8px);
      background:linear-gradient(180deg, rgba(10,20,40,.0), rgba(10,20,40,.86));
      padding:10px 12px; border-top:1px solid rgba(255,255,255,.12); z-index:40;
    }
    .dock-inner { max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:8px; }
    .dock-row{ display:flex; gap:8px; }
    .dock .btn { flex:1; min-height:48px; font-size:16px; }

    /* ä¿®æ”¹ï¼é‡æ–°è¼¸å…¥ï¼šé¡¯ç¤ºæ›´å¹³æ»‘ï¼Œé¿å…é–ƒçˆ */
    .dock-aux{ display:none; opacity:0; transform:translateY(6px); transition:opacity .18s ease, transform .18s ease; }
    .dock-aux.show{ display:flex; opacity:1; transform:translateY(0); }

    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:76px; background:#1f2937; color:#fff; padding:10px 14px; border-radius:12px; font-size:14px; opacity:0; pointer-events:none; transition:.25s; z-index:60; }
    .toast.show{ opacity:1; }

    .page{ display:none; }
    .page.active{ display:block; }

    /* éµç›¤ï¼šå›ºå®š 10 æ¬„ */
    .kbd{ display:grid; grid-template-columns: repeat(10, 1fr); gap: var(--gap-small); }
    .row { margin-top:8px; }
    .key{
      display:flex; align-items:center; justify-content:center;
      padding:6px 0;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:#0e1a33; color:#fff;
      font-weight:800; font-size:var(--tile-size);
      user-select:none; -webkit-tap-highlight-color:transparent;
      min-width:0;
      -ms-touch-action: manipulation; touch-action: manipulation;
    }
    .key:active { transform:scale(.98); }
    .key[disabled]{ opacity:.5; filter:grayscale(.85); cursor:not-allowed; }

    .row-title { margin-top:8px; font-size:13px; opacity:.9; }

    /* ===== ç•¶å‰æ‰‹ç‰Œï¼šå›ºå®š 2 è¡Œï¼‹ç™½åœˆï¼Œä¸æˆªæ–·ï¼ˆå¯æ²å‹•ï¼‰ï¼›ç¬¬äºŒè¡Œé½Šé ­å°é½Š ===== */
    .hand-wrap{ scroll-margin-top:72px; }
    .hand{
      display:grid;
      grid-template-columns:auto 1fr;      /* å·¦ï¼šæ¨™ç±¤ï¼›å³ï¼šç‰Œåˆ— */
      align-items:start;
      column-gap:8px;
      padding: var(--hand-pad);
      border-radius:12px;
      outline:2px solid #fff; outline-offset:0;
      box-shadow:0 0 0 3px rgba(255,255,255,.15) inset;
      background: rgba(255,255,255,.03);
      /* é«˜åº¦å›ºå®šç‚º 2 è¡Œç‰Œçš„é«˜åº¦ï¼Œä¿æŒä¸Šä¸‹è·é›¢ä¸€è‡´ä¸”ä¸æ™ƒå‹• */
      --line-h: calc(var(--tile-size) * 1.35);
      min-height: calc(2 * var(--line-h) + 2px); /* +2px çµ¦è¡Œé–“éš™æ„Ÿ */
      max-height: calc(2 * var(--line-h) + 2px);
    }
    .hand-label{
      font-size:14px; opacity:.95; line-height:var(--line-h);
      padding-block:0; margin:0; align-self:start;
      /* è®“æ¨™ç±¤ä¸åƒèˆ‡å³å´ç‰Œåˆ—æ›è¡Œä½ˆå±€ */
    }
    .hand-tiles{
      display:flex; flex-wrap:wrap;
      gap: var(--hand-gap);
      align-content:flex-start;            /* å…©è¡Œç·Šè²¼ä¸Šæ–¹ï¼Œé–“è·ç”± gap æ±ºå®š */
      max-height: calc(2 * var(--line-h)); /* åªå…è¨± 2 è¡Œ */
      overflow:auto;                       /* å…§å®¹å¤šæ™‚å¯ç›´å‘æ»¾å‹•ï¼Œä¸æˆªæ–· */
      padding-block:0; margin:0;
    }
    .hand-btn{
      background: transparent;
      border: none;
      padding: 1px;
      font-size: calc(var(--tile-size) * 1.2);
      line-height: 1.05;
      color:#fff;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      -ms-touch-action: manipulation; touch-action: manipulation;
    }
    .hand-btn:active{ transform: scale(.96); }
    .hand-btn:focus{ outline: none; }

    /* åˆ†æçµæœåº•éƒ¨é•·æœŸç•™ç™½ï¼šé¿å… Dock/æŒ‰éˆ•å‡ºç¾æ™‚ç‰ˆé¢ç§»å‹• */
    #resultSpacer{ height: 120px; } /* JS æœƒè¦†è“‹æˆ Dock å¯¦éš›é«˜åº¦ */
    #result { font-size: var(--tile-size); line-height:1.55; white-space:pre-wrap; }

    .chips{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">

      <!-- é ‚éƒ¨ï¼šæ¨™é¡Œ + è¦å‰‡/è¿”å›æŒ‰éˆ• -->
      <div class="topbar">
        <div class="title">æ¸¯å¼å°ç£éº»é›€åˆ†æå™¨ Â· ç¶²é ç‰ˆ</div>
        <div>
          <button class="btn sm" id="btnToRules" aria-controls="page-rules">è¦å‰‡</button>
          <button class="btn sm" id="btnBackToMain" aria-controls="page-main" style="display:none">è¿”å›è¼¸å…¥</button>
        </div>
      </div>

      <!-- ä¸»é  -->
      <section id="page-main" class="page active">
        <div class="card" id="card-input">
          <div class="section-title">è¼¸å…¥æ‰‹ç‰Œ</div>

          <!-- æ§åˆ¶åˆ—ï¼šæ¸…ç©ºï¼ˆå·¦ï¼‰ï½œé¡¯ç¤ºè¼¸å…¥æ¬„ï¼ˆä¸­ï¼‰ï½œæ•´ç†ï¼ˆå³ï¼‰ -->
          <div class="field" id="controlRow" style="margin-bottom:8px">
            <button class="btn sm" id="btnClearTop" type="button" title="æ¸…ç©ºè¼¸å…¥">æ¸…ç©º</button>

            <div class="spacer"></div>
            <button class="btn sm ghost" id="btnToggleInput" type="button" aria-expanded="false" aria-controls="inputPanel">é¡¯ç¤ºè¼¸å…¥æ¬„</button>

            <div class="spacer"></div>
            <button class="btn sm" id="btnSort" type="button" title="ä¾éµç›¤é †åºæ•´ç†">æ•´ç†</button>
          </div>

          <!-- å¯å±•é–‹è¼¸å…¥é¢æ¿ï¼ˆé è¨­éš±è—ï¼‰ -->
          <div id="inputPanel" class="input-panel">
            <div id="inputAlign" class="input-align">
              <input id="tilesInput" type="text" inputmode="latin" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="è¼¸å…¥ç‰Œçµ„æˆ–ä½¿ç”¨ä¸‹æ–¹ç‰Œé¢éµç›¤" />
            </div>
          </div>

          <!-- ç•¶å‰æ‰‹ç‰Œï¼ˆå›ºå®š 2 è¡Œ + ç™½åœˆï¼›ç¬¬äºŒè¡Œé½Šé ­ï¼‰ -->
          <div id="handWrap" class="hand-wrap">
            <div id="unicodeHand" class="muted" style="margin-bottom:8px"></div>
          </div>

          <div class="section-title">å¿«é€Ÿè¼¸å…¥éµç›¤</div>

          <div class="row-title">ç­’</div>
          <div class="kbd row" id="row-t"></div>

          <div class="row-title">ç´¢</div>
          <div class="kbd row" id="row-s"></div>

          <div class="row-title">è¬</div>
          <div class="kbd row" id="row-m"></div>

          <div class="row-title">å­—</div>
          <div class="kbd row" id="row-z"></div>
        </div>

        <!-- åˆ†æçµæœ -->
        <div class="card" style="margin-top:12px">
          <div class="section-title">åˆ†æçµæœ</div>
          <div id="result" aria-live="polite"></div>
          <div id="resultSpacer"></div>
        </div>
      </section>

      <!-- è¦å‰‡é  -->
      <section id="page-rules" class="page">
        <div class="card">
          <div class="section-title">è¦å‰‡</div>
          <div class="muted" style="line-height:1.7; font-size:15px;">
            <ul>
              <li>èŠ±è‰²ï¼šè¬(m)ã€ç­’(t)ã€ç´¢(s)ã€å­—(z)ï¼›ç™¾æ­ï¼š<span class="mono">X</span></li>
              <li>è½ç‰Œï¼š4ã€7ã€10ã€13ã€16 å¼µï¼›èƒ¡ç‰Œï¼š5ã€8ã€11ã€14ã€17 å¼µ</li>
              <li>å¯è¼¸å…¥ã€Œé€£ä¸²ã€æˆ–ã€Œç©ºç™½åˆ†éš”ã€æ ¼å¼</li>
            </ul>
          </div>
        </div>
      </section>

    </div>

    <!-- åº•éƒ¨ Dockï¼šä¸Šæ–¹æ˜¯ä¿®æ”¹ï¼é‡æ–°è¼¸å…¥ï¼Œåº•ä¸‹æ˜¯è‡ªå‹•åˆ†æ -->
    <div class="dock" id="dock">
      <div class="dock-inner">
        <div class="dock-row dock-aux" id="dockAux">
          <button class="btn secondary" id="btnEditFloat" type="button" title="ä¿®æ”¹ï¼ˆæ²å›æ‰‹ç‰Œ/éµç›¤ï¼‰">ä¿®æ”¹</button>
          <button class="btn secondary" id="btnReenterFloat" type="button" title="é‡æ–°è¼¸å…¥ï¼ˆæ¸…ç©ºï¼‰">é‡æ–°è¼¸å…¥</button>
        </div>
        <div class="dock-row">
          <button class="btn primary" id="btnCheck">è‡ªå‹•åˆ†æ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ======= Mahjong æ ¸å¿ƒ ======= */
const SUITS=['m','t','s']; const HONORS=['1z','2z','3z','4z','5z','6z','7z']; const JOKER='X';
const VALID_WIN=new Set([5,8,11,14,17]); const VALID_TING=new Set([4,7,10,13,16]);

const UNICODE_TILES={
  '1m':'ğŸ€‡','2m':'ğŸ€ˆ','3m':'ğŸ€‰','4m':'ğŸ€Š','5m':'ğŸ€‹','6m':'ğŸ€Œ','7m':'ğŸ€','8m':'ğŸ€','9m':'ğŸ€',
  '1t':'ğŸ€™','2t':'ğŸ€š','3t':'ğŸ€›','4t':'ğŸ€œ','5t':'ğŸ€','6t':'ğŸ€','7t':'ğŸ€Ÿ','8t':'ğŸ€ ','9t':'ğŸ€¡',
  '1s':'ğŸ€','2s':'ğŸ€‘','3s':'ğŸ€’','4s':'ğŸ€“','5s':'ğŸ€”','6s':'ğŸ€•','7s':'ğŸ€–','8s':'ğŸ€—','9s':'ğŸ€˜',
  '1z':'ğŸ€€','2z':'ğŸ€','3z':'ğŸ€‚','4z':'ğŸ€ƒ','5z':'ğŸ€„ï¸','6z':'ğŸ€…','7z':'ğŸ€†','X':'ğŸ€ª'
};

function formatTile(t){ return UNICODE_TILES[t]||t }
function normalizeInput(s){ return s.normalize('NFKC').trim() }
function validateCounts(tiles){
  const c=new Map(); for(const t of tiles){ c.set(t,(c.get(t)||0)+1) }
  for(const [t,count] of c){ if(t!=='X' && count>4) throw new Error(`ç‰Œ ${t} æ•¸é‡è¶…é4å¼µï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚`) }
}

/* è§£æè¼¸å…¥ï¼›é™åˆ¶æœ€å¤š 17 å¼µ */
function parseTiles(input){
  let parts=normalizeInput(input); if(!parts) return [];
  let tokens=parts.split(/\s+/).filter(Boolean);

  if(tokens.length===1){
    const s=tokens[0]; const out=[];
    for(let i=0;i<s.length;){
      const ch=s[i]; const up=ch.toUpperCase();
      if(up==='X'){ out.push('X'); i++; continue }
      if(/\d/.test(ch)){
        if(i+1<s.length && /[mtsz]/.test(s[i+1])){ out.push(ch+s[i+1]); i+=2; continue }
        let digits=ch; i++;
        while(i<s.length && /\d/.test(s[i])){ digits+=s[i]; i++; }
        if(i<s.length && /[mtsz]/.test(s[i])){
          const suit=s[i]; i++;
          for(const d of digits){
            const n=+d;
            if(suit==='z' && !(1<=n&&n<=7)) throw new Error(`ç„¡æ•ˆçš„å­—ç‰Œ: ${d}z`);
            if('mts'.includes(suit) && !(1<=n&&n<=9)) throw new Error(`ç„¡æ•ˆçš„æ•¸å­—: ${d}ï¼ŒèŠ±è‰² ${suit} æ‡‰ç‚º 1-9`);
            out.push(d+suit);
            if(out.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰å·²é” ${out.length} å¼µ`);
          }
        } else { throw new Error(`æ ¼å¼éŒ¯èª¤ï¼šæ•¸å­— ${digits} å¾Œç¼ºå°‘èŠ±è‰²`); }
      } else { throw new Error(`ç„¡æ•ˆçš„å­—å…ƒ: ${ch}`) }
    }
    validateCounts(out);
    if(out.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰ç‚º ${out.length} å¼µ`);
    return out;
  }

  const res=[];
  for(const tk of tokens){
    if(tk.toUpperCase()==='X'){ res.push('X'); if(res.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰å·²é” ${res.length} å¼µ`); continue }
    let i=0, digits='';
    while(i<tk.length){
      const ch=tk[i];
      if(/\d/.test(ch)){ digits+=ch; i++; }
      else if(/[mtsz]/.test(ch)){
        for(const d of digits){
          const n=+d;
          if(ch==='z' && !(1<=n&&n<=7)) throw new Error(`ç„¡æ•ˆçš„å­—ç‰Œ: ${d}z`);
          if('mts'.includes(ch) && !(1<=n&&n<=9)) throw new Error(`ç„¡æ•ˆçš„æ•¸å­—: ${d}ï¼ŒèŠ±è‰² ${ch} æ‡‰ç‚º 1-9`);
          res.push(`${d}${ch}`);
          if(res.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰å·²é” ${res.length} å¼µ`);
        }
        digits=''; i++;
      } else if(ch.toUpperCase()==='X'){ res.push('X'); i++; if(res.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰å·²é” ${res.length} å¼µ`); }
      else { throw new Error(`ç„¡æ•ˆçš„å­—å…ƒ: ${ch}`); }
    }
    if(digits) throw new Error(`æ ¼å¼éŒ¯èª¤ï¼šæ•¸å­—å¾Œç¼ºå°‘èŠ±è‰² (${digits})`);
  }
  validateCounts(res);
  if(res.length>17) throw new Error(`ç‰Œå¼µæ•¸æœ€å¤š 17 å¼µï¼Œç›®å‰ç‚º ${res.length} å¼µ`);
  return res;
}

function isTriplet(trio){ return trio.length===3 && trio[0]===trio[1] && trio[1]===trio[2] }
function isSequence(trio){
  if(trio.length!==3) return false;
  const suit=trio[0][1]; if(!('mts'.includes(suit))) return false;
  if(!(trio.every(t=>t[1]===suit))) return false;
  const nums=trio.map(t=>parseInt(t[0],10)).sort((a,b)=>a-b);
  return nums[2]-nums[0]===2 && nums[1]-nums[0]===1
}
function allTiles(){ return [...SUITS.flatMap(s=>Array.from({length:9},(_,i)=>`${i+1}${s}`)), ...HONORS] }
function substituteJokers(tiles){
  const j=tiles.filter(t=>t==='X').length; const base=tiles.filter(t=>t!=='X'); if(j===0) return [tiles];
  const candidates=allTiles().filter(t=> base.filter(x=>x===t).length<4);
  const results=[];
  function back(idx,acc){
    if(idx===j){
      const arr=[...base,...acc]; const c=new Map(); let ok=true;
      for(const t of arr){ c.set(t,(c.get(t)||0)+1); if(c.get(t)>4){ ok=false; break; } }
      if(ok) results.push(arr); return;
    }
    for(const tile of candidates){ acc.push(tile); back(idx+1,acc); acc.pop(); }
  }
  back(0,[]); return results;
}
const memoTry=new Map();
function tryMelds(tiles){
  const key=tiles.slice().sort().join(',');
  if(memoTry.has(key)) return memoTry.get(key);
  if(tiles.length===0) return [[]];
  const res=[]; const c=new Map();
  for(const t of tiles){ c.set(t,(c.get(t)||0)+1); }
  for(const [tile,count] of c){
    if(count>=3){
      const rem=tiles.slice(); let removed=0;
      for(let i=rem.length-1;i>=0 && removed<3;i--){ if(rem[i]===tile){ rem.splice(i,1); removed++; } }
      for(const sub of tryMelds(rem)) res.push([[tile,tile,tile], ...sub]);
    }
  }
  const uniq=[...new Set(tiles)].sort();
  for(const t of uniq){
    if(t.length!==2) continue; const suit=t[1]; const r=parseInt(t[0],10);
    if(!('mts'.includes(suit))) continue; if(Number.isNaN(r)||r>=8) continue;
    const t1=`${r}${suit}`, t2=`${r+1}${suit}`, t3=`${r+2}${suit}`;
    if(tiles.includes(t1)&&tiles.includes(t2)&&tiles.includes(t3)){
      const rem=tiles.slice();
      [t1,t2,t3].forEach(x=>{ const idx=rem.indexOf(x); if(idx>-1) rem.splice(idx,1); });
      for(const sub of tryMelds(rem)) res.push([[t1,t2,t3], ...sub]);
    }
  }
  memoTry.set(key,res); return res;
}
function findWinCombinations(hand){
  if(!VALID_WIN.has(hand.length)) return [];
  const unique=new Set(); const out=[];
  for(const sub of substituteJokers(hand)){
    const cnt=new Map(); for(const t of sub){ cnt.set(t,(cnt.get(t)||0)+1); }
    const eyes=[...cnt].filter(([,v])=>v>=2).map(([k])=>k);
    for(const eye of eyes){
      const temp=sub.slice(); let removed=0;
      for(let i=temp.length-1;i>=0 && removed<2;i--){ if(temp[i]===eye){ temp.splice(i,1); removed++; } }
      const melds=tryMelds(temp);
      for(const m of melds){
        const all=[[eye,eye],...m];
        const k=all.map(x=>x.slice().sort().join('')).sort().join('|');
        if(!unique.has(k)){ unique.add(k); out.push({ melds: all }); }
      }
    }
  }
  return out;
}
function formatCombinations(combos){
  if(!combos||!combos.length) return 'ç„¡æ³•èƒ¡ç‰Œ';
  let out=[], idx=1;
  for(const c of combos){
    const m=c.melds; const lines=[];
    lines.push(`çµ„åˆ ${idx++}:`);
    lines.push(`  å°‡ç‰Œ: ${m[0].map(formatTile).join(' ')}`);
    for(let i=1;i<m.length;i++){
      const s=m[i].map(formatTile).join(' ');
      if(isTriplet(m[i])) lines.push(`  åˆ»å­ ${i}: ${s}`);
      else if(isSequence(m[i])) lines.push(`  é †å­ ${i}: ${s}`);
      else lines.push(`  é¢å­ ${i}: ${s}`);
    }
    out.push(lines.join('\n'));
  }
  return out.join('\n\n');
}
function countMap(a){ const m=new Map(); for(const t of a){ m.set(t,(m.get(t)||0)+1); } return m; }
function analyzeTingCandidates(hand){
  if(!VALID_TING.has(hand.length)) return {};
  const waiting={}; const hc=countMap(hand);
  for(const tile of allTiles()){
    if((hc.get(tile)||0)>=4) continue;
    const temp=hand.concat([tile]);
    const combos=findWinCombinations(temp);
    if(combos.length) waiting[tile]=combos;
  }
  return waiting;
}
function analyzeTingTilesOnly(hand){
  const m=analyzeTingCandidates(hand); const tiles=Object.keys(m);
  const order={ 't':0,'s':1,'m':2,'z':3,'X':4 };
  tiles.sort((a,b)=>{
    const sa=a[a.length-1], sb=b[b.length-1];
    const na=parseInt(a,10)||0, nb=parseInt(b,10)||0;
    const oa=order[sa]??99, ob=order[sb]??99;
    if(oa!==ob) return oa-ob; return na-nb;
  });
  return tiles;
}
function analyzeDiscardToTing(hand){
  if(!VALID_WIN.has(hand.length)) return [];
  const res=[];
  for(let i=0;i<hand.length;i++){
    const nh=hand.slice(0,i).concat(hand.slice(i+1));
    const ting=analyzeTingTilesOnly(nh);
    if(ting.length) res.push({ discard:hand[i], ting_tiles:ting });
  }
  return res;
}

/* ======= UI glue ======= */
const $=s=>document.querySelector(s);

const pageMain = $('#page-main');
const pageRules = $('#page-rules');
const btnToRules = $('#btnToRules');
const btnBackToMain = $('#btnBackToMain');
const dock = $('#dock');

const tilesInput=$('#tilesInput');
const inputPanel=$('#inputPanel');
const inputAlign=$('#inputAlign');
const btnToggleInput=$('#btnToggleInput');

const resultEl=$('#result');
const resultSpacer=$('#resultSpacer');
const unicodeHandEl=$('#unicodeHand');

const controlRow=$('#controlRow');
const dockAux=$('#dockAux');
const btnEditFloat=$('#btnEditFloat');
const btnReenterFloat=$('#btnReenterFloat');

/* é é¢åˆ‡æ› */
function showMain(){
  pageMain.classList.add('active'); pageRules.classList.remove('active');
  btnBackToMain.style.display='none'; btnToRules.style.display='';
  dock.style.display='';
}
function showRules(){
  pageRules.classList.add('active'); pageMain.classList.remove('active');
  btnBackToMain.style.display=''; btnToRules.style.display='none';
  dock.style.display='none';
  hideDockAux();
}
btnToRules.addEventListener('click', showRules);
btnBackToMain.addEventListener('click', showMain);

function setResult(t){ resultEl.textContent=t }

/* å±•é–‹ / æ”¶åˆè¼¸å…¥é¢æ¿ï¼ˆä¿æŒåœ¨å¡ç‰‡å…§ï¼Œä¸¦å°é½Šæ‰‹ç‰Œç™½æ¡†é‚Šè·ï¼‰ */
btnToggleInput.addEventListener('click', ()=>{
  const open = !inputPanel.classList.contains('active');
  inputPanel.classList.toggle('active', open);
  btnToggleInput.setAttribute('aria-expanded', open?'true':'false');
  btnToggleInput.textContent = open ? 'éš±è—è¼¸å…¥æ¬„' : 'é¡¯ç¤ºè¼¸å…¥æ¬„';
  if(open && tilesInput){
    layoutInputToHandEdges();
    tilesInput.focus();
  }
});

/* æ‰‹ç‰Œæ¸²æŸ“ï¼ˆå›ºå®š 2 è¡Œ + ç™½åœˆï¼Œç¬¬äºŒè¡Œé½Šé ­ï¼‰ */
function renderHandButtons(arr){
  if(!arr.length){ unicodeHandEl.innerHTML=''; layoutInputToHandEdges(); return; }
  let html = `
    <div class="hand">
      <div class="hand-label">ç•¶å‰æ‰‹ç‰Œï¼š</div>
      <div class="hand-tiles">
  `;
  arr.forEach((t,i)=>{
    html += `<button class="hand-btn" type="button" data-idx="${i}" aria-label="åˆªé™¤ ${t}" title="åˆªé™¤ ${t}">${formatTile(t)}</button>`;
  });
  html += `</div></div>`;
  unicodeHandEl.innerHTML = html;
  layoutInputToHandEdges();   // ä¾æ‰‹ç‰Œä½ç½®èª¿æ•´è¼¸å…¥æ¬„å°é½Š
}
function setUnicodeHand(arr){ renderHandButtons(arr); }

/* åˆªç‰Œï¼ˆäº‹ä»¶å§”æ´¾ï¼‰ */
unicodeHandEl.addEventListener('pointerup', (e)=>{
  const btn = e.target.closest('.hand-btn');
  if(!btn) return;
  e.preventDefault();
  try{
    const tiles = parseTiles(tilesInput.value);
    const idx = +btn.dataset.idx;
    if (!Number.isNaN(idx) && idx>=0 && idx<tiles.length){
      tiles.splice(idx,1);
      writeTiles(tiles);
      fireFormat();
      updateKeyboardState();
    }
  }catch(_){}
});

/* è¨ˆæ•¸èˆ‡éµç›¤ç‹€æ…‹ */
const tileCounts = new Map();
function totalCount(){ let sum = 0; for (const v of tileCounts.values()) sum += v; return sum; }
function recountFromInput(){
  tileCounts.clear();
  try {
    const tiles = parseTiles(tilesInput.value);
    for (const x of tiles) tileCounts.set(x, (tileCounts.get(x)||0)+1);
  } catch(e) { /* ignore */ }
}
function updateKeyboardState(){
  const tot = totalCount();
  document.querySelectorAll('.kbd .key[data-tile]').forEach(btn=>{
    const code = btn.dataset.tile;
    const cnt = tileCounts.get(code) || 0;
    btn.disabled = (cnt >= 4) || (tot >= 17);
    btn.setAttribute('aria-disabled', btn.disabled ? 'true':'false');
  });
}

/* å»ºéµç›¤èˆ‡è¼¸å…¥æ’å…¥ */
function insertText(t){
  const cnt = (tileCounts.get(t) || 0);
  if (cnt >= 4) return;
  const tot = totalCount();
  if (tot >= 17) return;

  const cur=tilesInput.value;
  tilesInput.value=(cur?cur.replace(/\s+$/,'')+' ':'')+t+' ';
  tileCounts.set(t, cnt+1);
  fireFormat();
  updateKeyboardState();
}
function buildRow(el, list){
  for(const code of list){
    const btn=document.createElement('button');
    btn.className='key';
    btn.type='button';
    btn.dataset.tile=code;
    btn.textContent = UNICODE_TILES[code] || code;
    btn.title = code;
    btn.setAttribute('aria-label', code);
    btn.addEventListener('pointerup',(e)=>{
      e.preventDefault();
      insertText(code);
    }, {passive:false});
    el.appendChild(btn);
  }
}
buildRow(document.getElementById('row-t'), Array.from({length:9},(_,i)=>`${i+1}t`));
buildRow(document.getElementById('row-s'), Array.from({length:9},(_,i)=>`${i+1}s`));
buildRow(document.getElementById('row-m'), Array.from({length:9},(_,i)=>`${i+1}m`));
buildRow(document.getElementById('row-z'), [...Array.from({length:7},(_,i)=>`${i+1}z`), 'X']);

/* æ’åºï¼ˆæ•´ç†ï¼‰ */
function sortTilesByKeyboardOrder(arr){
  const suitOrder = { 't':0, 's':1, 'm':2, 'z':3, 'X':4 };
  return arr.slice().sort((a,b)=>{
    const sa = a === 'X' ? 'X' : a[1];
    const sb = b === 'X' ? 'X' : b[1];
    const oa = suitOrder[sa] ?? 99;
    const ob = suitOrder[sb] ?? 99;
    if(oa !== ob) return oa - ob;
    const na = a === 'X' ? 0 : parseInt(a[0],10);
    const nb = b === 'X' ? 0 : parseInt(b[0],10);
    return na - nb;
  });
}
document.getElementById('btnSort').addEventListener('click', ()=>{
  try{
    const tiles = parseTiles(tilesInput.value);
    const sorted = sortTilesByKeyboardOrder(tiles);
    writeTiles(sorted);
    fireFormat();
    updateKeyboardState();
  }catch(e){
    showToast('ç„¡æ³•æ•´ç†ï¼š' + e.message);
  }
});

/* æ¸…ç©ºï¼ˆä½æ–¼æ•´ç†å·¦å´ï¼‰ */
document.getElementById('btnClearTop').addEventListener('click',()=>{
  tilesInput.value='';
  setUnicodeHand([]); setResult('');
  tileCounts.clear();
  updateKeyboardState();
  updateDockAuxVisibility();
});

/* å¯«å›è¼¸å…¥æ¡† */
function writeTiles(arr){
  tilesInput.value = arr.join(' ') + (arr.length ? ' ' : '');
}

/* å³æ™‚æ ¼å¼åŒ– */
function fireFormat(){
  try{
    const tiles=parseTiles(tilesInput.value);
    setUnicodeHand(tiles);
    recountFromInput();
    updateKeyboardState();
  }catch(e){
    recountFromInput();
    updateKeyboardState();
  }
}

/* è‡ªå‹•åˆ†æï¼šå®Œæˆå¾Œæ›´æ–°çµæœã€é¡¯ç¤ºé‚è¼¯èˆ‡åº•éƒ¨ç•™ç™½ */
document.getElementById('btnCheck').addEventListener('click',()=>{
  try{
    const tiles=parseTiles(tilesInput.value); const n=tiles.length; setUnicodeHand(tiles);

    if(VALID_TING.has(n)){
      const ting=analyzeTingTilesOnly(tiles);
      if(ting.length===0){ setResult('æ­¤ç‰Œçµ„å°šæœªè½ç‰Œã€‚'); }
      else{ setResult('æ­¤ç‰Œçµ„æ­£åœ¨è½ç‰Œï¼š\n'+ting.map(formatTile).join(' ')); }
    }else if(VALID_WIN.has(n)){
      const win=findWinCombinations(tiles);
      if(win.length){ setResult(`æ­¤ç‰Œçµ„å¯èƒ¡ç‰Œï¼Œå…± ${win.length} ç¨®çµ„åˆï¼š\n\n`+formatCombinations(win)); }
      else{
        const sug=analyzeDiscardToTing(tiles);
        if(!sug.length){ setResult('æ­¤ç‰Œçµ„ç„¡æ³•èƒ¡ç‰Œï¼Œä¹Ÿç„¡è½ç‰Œæ½›åŠ›ã€‚'); }
        else{
          const lines=['ç„¡æ³•èƒ¡ç‰Œï¼Œä½†å¯è€ƒæ…®ä¸‹åˆ—æ‰“æ³•é€²å…¥è½ç‰Œï¼š'];
          for(const s of sug){ lines.push(`æ¨æ£„ ${formatTile(s.discard)} âœ è½ç‰Œ: `+ s.ting_tiles.map(formatTile).join(' ')) }
          setResult(lines.join('\n'));
        }
      }
    }else{
      setResult('éŒ¯èª¤ï¼šç‰Œå¼µæ•¸ä¸åˆæ³•ï¼ˆå°ç›¸å…¬/å¤§ç›¸å…¬ï¼‰ã€‚');
    }

    adjustResultSpacer(true);
    updateDockAuxVisibility();
    resultEl.scrollIntoView({ behavior:'smooth', block:'start' });

  }catch(e){
    setResult('éŒ¯èª¤ï¼š'+e.message);
    adjustResultSpacer(true);
    updateDockAuxVisibility();
  }
});

/* Dock ä¸Šæ–¹æ“ä½œï¼šä¿®æ”¹ï¼ˆæ²å›æ‰‹ç‰Œ/éµç›¤ï¼‰ã€é‡æ–°è¼¸å…¥ï¼ˆæ¸…ç©ºï¼‰ */
btnEditFloat.addEventListener('click', ()=>{
  document.getElementById('handWrap').scrollIntoView({ behavior:'smooth', block:'start' });
});
btnReenterFloat.addEventListener('click', ()=>{
  tilesInput.value='';
  setUnicodeHand([]); setResult('');
  tileCounts.clear(); updateKeyboardState();
  adjustResultSpacer(false);
  updateDockAuxVisibility();
});

/* ------------- é¡¯ç¤ºé‚è¼¯æ›´å¹³æ»‘ï¼šæœ‰çµæœ â†’ æ§åˆ¶åˆ—åœ¨è¦–çª—å…§å‰‡éš±è—ï¼Œå…¶é¤˜é¡¯ç¤º ------------- */
let controlRowVisible = false;
let auxDebounceTimer = null;
const io = new IntersectionObserver(entries=>{
  controlRowVisible = entries[0]?.isIntersecting ?? false;
  // åŠ å…¥å»æŠ–å‹•ï¼Œé¿å…æ‰‹æ©Ÿå¿«é€Ÿæ»‘å‹•é€ æˆé–ƒçˆ
  clearTimeout(auxDebounceTimer);
  auxDebounceTimer = setTimeout(updateDockAuxVisibility, 120);
}, { root:null, threshold:0, rootMargin: "120px 0px -40% 0px" });
io.observe(controlRow);

function hasResult(){
  return (resultEl.textContent || '').trim().length > 0;
}
function showDockAux(){ dockAux.classList.add('show'); }
function hideDockAux(){ dockAux.classList.remove('show'); }
function updateDockAuxVisibility(){
  if(!hasResult()){ hideDockAux(); return; }
  if(controlRowVisible){ hideDockAux(); }
  else { showDockAux(); }
}

/* ===== ç‰ˆé¢ç©©å®šï¼šé•·æœŸä¿ç•™åº•éƒ¨ç©ºéš™ï¼Œä¾ Dock çœŸå¯¦é«˜åº¦èª¿æ•´ ===== */
function adjustResultSpacer(forceKeep){
  const dockHeight = dock?.offsetHeight || 0;
  // é•·æœŸä¿ç•™ï¼šä¸è«–æ˜¯å¦æœ‰çµæœï¼Œéƒ½ä¿ç•™è¶³å¤ ç©ºé–“ï¼ˆé¿å…è·³å‹•ï¼‰
  const auxShown = dockAux.classList.contains('show') || !!forceKeep;
  const keep = Math.max(dockHeight * (auxShown ? 2 : 1), 96);
  resultSpacer.style.height = keep + 'px';
}

/* ===== è¼¸å…¥æ¬„å°é½Šæ‰‹ç‰Œç™½æ¡†å…§é‚Šç·£ï¼ˆå‘å³å»¶ä¼¸ï¼Œå·¦å³èˆ‡ç™½æ¡†ä¸€è‡´ï¼‰ ===== */
function layoutInputToHandEdges(){
  const card = document.getElementById('card-input');
  const hand = unicodeHandEl.querySelector('.hand');
  const tiles = unicodeHandEl.querySelector('.hand-tiles');

  if(!card || !hand || !tiles || !inputAlign) return;

  const cardRect  = card.getBoundingClientRect();
  const tilesRect = tiles.getBoundingClientRect();
  const handRect  = hand.getBoundingClientRect();

  // å·¦å´éœ€è¦èˆ‡ç‰Œåˆ—é½Šé ­ï¼ˆè€Œéèˆ‡æ¨™ç±¤é½Šé ­ï¼‰
  const leftOffset = Math.max(0, Math.round(tilesRect.left - cardRect.left));
  // å³å´å¯¬åº¦ï¼šåˆ°æ‰‹ç‰Œç™½æ¡†å³ç·£ï¼ˆå« hand paddingï¼‰
  const rightLimit = Math.round(handRect.right - cardRect.left);
  const maxW = Math.max(0, rightLimit - leftOffset);

  // å¥—ç”¨åˆ°è¼¸å…¥æ¬„åŒ…è£¹å®¹å™¨ï¼Œä½¿ input å³é‚Šèˆ‡ç™½æ¡†ä¸€è‡´ã€å·¦é‚Šèˆ‡ç‰Œåˆ—é½Šé ­
  inputAlign.style.marginLeft = leftOffset + 'px';
  inputAlign.style.maxWidth   = maxW + 'px';
}

/* è¼”åŠ©ï¼šåå¸ */
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1600);
}

/* ====== å…¶ä»– ====== */
document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {passive:false});
let lastTouchEnd = 0;
document.addEventListener('touchend', function (e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) { e.preventDefault(); }
  lastTouchEnd = now;
}, { passive:false });

/* åˆå§‹ */
function init(){
  recountFromInput();
  updateKeyboardState();
  fireFormat();
  adjustResultSpacer(false);
  updateDockAuxVisibility();
  layoutInputToHandEdges();
}
init();

/* è¼¸å…¥æ™‚å»¶é²æ ¼å¼åŒ– */
let typingTimer; 
document.getElementById('tilesInput').addEventListener('input',()=>{
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{
    fireFormat();
    adjustResultSpacer(false);
    updateDockAuxVisibility();
    layoutInputToHandEdges();
  }, 120)
});

/* è¦–çª—å¤§å°/æ–¹å‘æ”¹è®Šæ™‚ï¼Œé‡æ–°é‡æ¸¬ä¸¦æ›´æ–°å¸ƒå±€ */
window.addEventListener('resize', ()=>{
  adjustResultSpacer(false);
  updateDockAuxVisibility();
  layoutInputToHandEdges();
});
</script>
</body>
</html>
